use strict;
pp_bless ("PDL::OpenCV::VideoCapture");
pp_addpm ({At=>'Top'},<<"EOPM");
use strict;
use warnings;
EOPM

pp_addhdr << 'EOH';
#include "opencv_wrapper.h"
typedef VideoCaptureWrapper *PDL__OpenCV__VideoCapture;
EOH

pp_addpm(<<'EOD');
=head2 new_uri

=for ref

Initialize OpenCV videocapture.

=for example

        $capture = PDL::OpenCV::VideoCapture->new_uri($uri);
EOD

pp_addxs(<<'EOF');
PDL__OpenCV__VideoCapture new_uri(klass,uri)
        char *klass
        char *uri
CODE:
  RETVAL = cw_VideoCapture_new();
  if (RETVAL) {
    if (!cw_VideoCapture_open(RETVAL, uri)) {
      cw_VideoCapture_DESTROY(RETVAL);
      PDL->pdl_barf("Error opening URI '%s'", uri);
    }
  }
 OUTPUT:
  RETVAL

MODULE = PDL::OpenCV::VideoCapture PACKAGE = PDL::OpenCV::VideoCapture PREFIX=cw_VideoCapture_

void
cw_VideoCapture_DESTROY(PDL__OpenCV__VideoCapture self)

double
cw_VideoCapture_get(PDL__OpenCV__VideoCapture self, int propId)
EOF

pp_def('read',
        Pars=>'[oca] m(l,c,r);',
        OtherPars => 'PDL__OpenCV__VideoCapture wr',
        HaveBroadcasting=>0, NoPthread=>1, # I/O
        Comp => 'MatWrapper *mw;',
        MakeComp => <<'EOF',
                if (!($COMP(mw) = cw_Mat_new()))
                  $CROAK("cw_Mat_new returned null.");
                if (!cw_VideoCapture_read($COMP(wr), $COMP(mw)))
                  $CROAK("failed to read");
EOF
        CompFreeCodeComp => 'if ($COMP(mw)) cw_Mat_DESTROY($COMP(mw));',
        RedoDimsCode=>pp_line_numbers(__LINE__, <<'EOF'),
                cw_Mat_pdlDims($COMP(mw), &$PDL(m)->datatype, &$SIZE(l), &$SIZE(c), &$SIZE(r));
EOF
        Code =>pp_line_numbers(__LINE__, <<'EOF'),
                PDL_Indx d[] = { $SIZE(l), $SIZE(c), $SIZE(r) };
                pdl *pid = $PDL(m);
                PDL->setdims(pid, d, 3);
                PDL->make_physical(pid);
                /* no $P(m) because was NULL on entry */
                memmove(pid->data, cw_Mat_ptr($COMP(mw)), pid->nbytes);
EOF
        PMCode => pp_line_numbers(__LINE__, <<'EOPM'),
        sub read {
                eval { _read_int(my $o = PDL->null, $_[0]); $o; };
        }
EOPM
        Doc=>"Read a frame from the source, or return undef on failure.",
);

pp_done();
